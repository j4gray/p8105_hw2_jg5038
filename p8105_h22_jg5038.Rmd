---
title: "Homework 2"
author: Julia Gray
output: github_document
date: "09-24-25"
---
```{r echo=TRUE, message=FALSE}
library(tidyverse)
library(readxl)
```

## Problem 1

First, let's check if in original dataset there are any rows where both prez_gop and prez_dem == 1

```{r message=FALSE}
filter(
  read_csv(file="./data/fivethirtyeight_datasets/pols-month.csv"), 
  prez_gop + prez_dem > 1)
```

We can see that there are 5 rows where prez_gop == 2 (from August-December 1974, which is when Ford took over after Nixon resigned) so we must take that into account when assigning president column.

Import and clean pos_month data
```{r message=FALSE}
pols_df = read_csv(file="./data/fivethirtyeight_datasets/pols-month.csv") |> 
  janitor::clean_names() |> 
  separate(
    col="mon",
    into=c("year", "month", "day"),
    sep="-"
  ) |> 
  mutate(
    month = 
      case_match(
        month, 
        "01" ~ "jan", 
        "02" ~ "feb",
        "03" ~ "mar",
        "04" ~ "apr", 
        "05" ~ "may",
        "06" ~ "jun",
        "07" ~ "jul",
        "08" ~ "aug",
        "09" ~ "sep",
        "10" ~ "oct",
        "11" ~ "nov",
        "12" ~ "dec") 
    ) |> 
  mutate(
    president = case_when(
      prez_gop >= 1 ~ "gop",
      prez_dem >= 1 ~ "dem"
    )
  ) |> 
  select(-day, -prez_dem, -prez_gop) |> 
  mutate(year = as.integer(year))
```

Import and clean snp data
```{r message=FALSE}
snp_df = read_csv(file="./data/fivethirtyeight_datasets/snp.csv") |> 
  separate(
    col = "date",
    into = c("month", "day", "year"),
    sep = "/"
  ) |>
  #in order to correctly sort we need to recast the strings for year and month as integers
  mutate(
    year = case_when(
      as.integer(year) <= 15 ~ as.integer(year) + 2000,
      as.integer(year) > 15 ~ as.integer(year) + 1900
    ),
    month = as.integer(month)
  ) |> 
  relocate("year", "month",  "day") |> 
  arrange(year, month, day) |> 
  #now that we've arranged year and month we can change month number month name to match pos_month_df
  mutate(
    month = 
      case_match(
        month, 
        1 ~ "jan", 
        2 ~ "feb",
        3 ~ "mar",
        4 ~ "apr", 
        5 ~ "may",
        6 ~ "jun",
        7 ~ "jul",
        8 ~ "aug",
        9 ~ "sep",
        10 ~ "oct",
        11 ~ "nov",
        12 ~ "dec") 
    ) |> 
  select(-day) |> 
  rename(snp_close=close)
```

Import and tidy unemployment data

```{r message=FALSE}
unemployment_df = read_csv(file="./data/fivethirtyeight_datasets/unemployment.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    jan:dec,
    names_to = "month", 
    values_to = "unemployment"
  )
```

Join all datasets
```{r}
fte_df = left_join(pols_df, snp_df, by = c("year", "month")) |> 
  left_join(unemployment_df, by = c("year", "month"))
```

These datasets contained information about the United States from `r range(select(fte_df, year))[1]` to `r range(select(fte_df, year))[2]`. The pols-month dataset contains information about the number of politicians who are republican or democrat at a given year/month. The snp dataset contains the closing values of the S&P stock market index for a year/month, selected on a given day either the 1st, 2nd, 3rd or 4th of the month. The unemployment dataset
contains the percentage of unemployment at a given month/year.

The resulting dataset has a dimension of `r dim(fte_df)` and covers `r range(select(fte_df, year))[1]` to `r range(select(fte_df, year))[2]`. The variables are `r unique(colnames(fte_df))`.

## Problem 2

```{r}
mr_tw_df = read_excel('./data/202409 Trash Wheel Collection Data.xlsx', range="Mr. Trash Wheel!A2:N653") |> 
  janitor::clean_names() |> 
  mutate(
    machine = 'mr',
    sports_balls = as.integer(round(sports_balls))
  ) |> 
  #month and year are redundant to date so let's remove them and then parse the date column
  select(-month, -year) |> 
  separate(
    col = "date",
    into = c("year", "month", "day"),
    sep = "-"
  ) |> 
  mutate (
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  )


prof_tw_df = read_excel('./data/202409 Trash Wheel Collection Data.xlsx', range="Professor Trash Wheel!A2:M120") |> 
  janitor::clean_names() |> 
  mutate(
    machine = 'prof',
  ) |> 
  select(-month, -year) |> 
  separate(
    col = "date",
    into = c("year", "month", "day"),
    sep = "-"
  ) |> 
  mutate (
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  )

gwyn_tw_df = read_excel('./data/202409 Trash Wheel Collection Data.xlsx', range="Gwynnda Trash Wheel!A2:L265") |> 
  janitor::clean_names() |> 
  mutate(
    machine = 'gwyn',
  ) |> 
  select(-month, -year) |> 
  separate(
    col = "date",
    into = c("year", "month", "day"),
    sep = "-"
  ) |> 
  mutate (
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  )


tw_df = bind_rows(mr_tw_df, prof_tw_df, gwyn_tw_df) |> 
  relocate(machine, year, month, day)
```


This data contains `r dim(tw_df)[1]` observations and includes summary data about the total amount of trash collected, both in weight (tons) and volume (cubic yards), as well as by type of trash (e.g. plastic bottles, glass bottles, cigarette butts). The total weight of trash collected by Professor Trash Wheel was `r sum(select(filter(tw_df, machine=='mr'), weight_tons))` tons. The total number of cigarette butts collected by Gwynda in June of 2022 was `r sum(select(filter(tw_df, machine=='gwyn', month==6, year==2022), cigarette_butts))`.


## Problem 3

Import data

```{r}
zip_df = read_csv(file="./data/zillow_data/Zip Codes.csv") |> 
  janitor::clean_names()

rent_df = read_csv(file="./data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  janitor::clean_names() |> 
  #update column names to match zip_df
  rename(
    zip_code = region_name,
    county = county_name) |> 
  mutate(
    county = str_replace(county, " County", "")
  ) |> 
  pivot_longer(
    cols=x2015_01_31:x2024_08_31,
    names_to = "date",
    values_to="observed_rent_index"
  ) |> 
  mutate(
    #let's use the lubridate package
    date = ymd(str_replace(date, "x", ""))
  ) 

```

Let's test a zip code before merging

```{r}
filter(zip_df, zip_code==10032)

filter(rent_df, zip_code==10032)
```

Do any zip codes map to more than 1 neighbordhood?

```{r}
#duplicated(select(zip_df, zip_code)) == TRUE)

zip_df[duplicated(select(zip_df, zip_code)), ]
```

We have 2 zipcodes that are duplicated 

```{r}
filter(zip_df, zip_code==10463)
filter(zip_df, zip_code==11201)
```

They are in 2 different counties so let's make sure we can map to rent_df

```{r}
unique(select(filter(rent_df, zip_code==10463), county))
unique(select(filter(rent_df, zip_code==11201), county))
```

In rent_df these zipcodes only have 1 county so we can join on zip_code and county

```{r}
rent_zip_df = left_join(rent_df, zip_df, by = c("county", "zip_code")) |> 
  relocate("zip_code", "neighborhood",  "date", "observed_rent_index")
```

In the resulting tidy dataset we can see the observed rent index by neighborhood. There are `r dim(rent_zip_df)[1]` observations (or `r dim(filter(rent_zip_df, !is.na(observed_rent_index)))[1]` when we exclude null values). There are `r dim(unique(select(rent_zip_df, zip_code)))[1]` unique zip codes and `r dim(unique(select(rent_zip_df, neighborhood)))[1]` unique neighborhoods.

To see what zip codes are in the zip_df but not the rent_df let's use an antijoin:

```{r}
zip_no_rent_df = anti_join(zip_df, rent_zip_df, by = "zip_code")
```

There are `r dim(select(zip_no_rent_df, zip_code))[1]` zip codes that appear in the zip codes dataset but not the zillow dataset. This is likely due to there being no residential real estate in that zip code. For example 10020 is an area in midtown from 48th-51st street and 5th-7th avenue that includes Radio City Music Hall and Rockefeller Center. Another illustrative example is 11371 which is the zip code for LaGuardia airport. 

Let's create a new dataframe to compare rent indexes from January 2020 to January 2021:

```{r}
covid_rent_df = filter(rent_zip_df, 
                       (year(date) == 2020 & month(date) == 1) | 
                         (year(date) == 2021 & month(date) == 1)) |> 
  select(zip_code, neighborhood, date, observed_rent_index) |> 
  pivot_wider(
    names_from=date,
    values_from=observed_rent_index,
    names_glue = "JAN_{year(date)}"
  ) |> 
  mutate(
    rent_difference = JAN_2021 - JAN_2020
  ) |> 
  arrange(rent_difference)
```

Use this dataframe to create a table of the top 10 zip codes by rent decrease in covid

```{r}
knitr::kable(slice(covid_rent_df, 1:10))
```

These are all popular (dare I say trendy) residential districts in Manhattan where high rents did not equate to lots of space but rather amenities that were unavailable during the pandemic. It is unsurprising that they experienced the highest rent decrease during this time.















